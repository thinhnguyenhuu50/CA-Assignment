\section{Cấu trúc chương trình}
Trò chơi Gomoku được xây dựng dựa trên một Máy trạng thái hữu hạn (FSM) nhằm điều khiển luồng của trò chơi, đảm bảo rằng mỗi giai đoạn—khởi tạo, lượt chơi của người chơi, và kết thúc—đều được xử lý một cách hệ thống. FSM mang lại một cách tiếp cận rõ ràng và có tổ chức trong việc quản lý tiến trình trò chơi, giúp cho chương trình trở nên mô-đun và dễ bảo trì.

Chương trình được chia thành một số thủ tục chính, mỗi thủ tục đảm nhận một vai trò riêng biệt, như khởi tạo bàn cờ, xử lý đầu vào từ người chơi, cập nhật trạng thái bàn cờ, kiểm tra điều kiện thắng hoặc hòa, và quản lý đầu ra. Các thủ tục này được gọi tương ứng trong các trạng thái của FSM, tạo ra sự chuyển đổi liền mạch giữa các phần của trò chơi.

\subsection{Máy trạng thái hữu hạn (FSM)}
FSM bao gồm bốn trạng thái chính:

\begin{itemize}
    \item \textbf{Khởi tạo}: Thiết lập bàn cờ và các biến khởi đầu của trò chơi.
    \item \textbf{Lượt chơi}: Quản lý việc nhận và xác thực nước đi từ người chơi hiện hành.
    \item \textbf{Kết thúc trò chơi (Thắng)}: Xử lý trường hợp khi một người chơi chiến thắng.
    \item \textbf{Kết thúc trò chơi (Hòa)}: Xử lý trường hợp trò chơi kết thúc hòa khi bàn cờ đầy mà không có người thắng.
\end{itemize}

Sự chuyển đổi giữa các trạng thái được điều khiển bởi các điều kiện cụ thể, như việc phát hiện nước thắng hoặc khi bàn cờ không còn vị trí trống. Hình \ref{fig:fsm} minh họa FSM với các trạng thái và mối quan hệ chuyển tiếp giữa chúng.

\begin{figure}[!htbp]
    \centering
    \input{graphics/section_2/FSM.tex}
    \caption{Máy trạng thái hữu hạn của trò chơi Gomoku}
    \label{fig:fsm}
\end{figure}

Trong FSM:
\begin{itemize}
    \item Trò chơi bắt đầu ở trạng thái \textbf{Khởi tạo}, nơi bàn cờ được thiết lập và người chơi đầu tiên được chọn.
    \item Tiếp theo, trò chơi chuyển sang trạng thái \textbf{Lượt chơi}, nơi người chơi thực hiện lần lượt các nước đi. Nếu nước đi không hợp lệ, trạng thái sẽ yêu cầu người chơi thử lại. Sau mỗi nước đi hợp lệ, chương trình sẽ kiểm tra xem người chơi có chiến thắng hay bàn cờ đã đầy.
    \item Nếu phát hiện có chiến thắng, FSM sẽ chuyển sang trạng thái \textbf{Kết thúc trò chơi (Thắng)} để thông báo người chiến thắng và kết thúc trò chơi.
    \item Nếu bàn cờ được lấp đầy mà không có chiến thắng, chương trình chuyển sang trạng thái \textbf{Kết thúc trò chơi (Hòa)} để thông báo trận đấu hòa.
\end{itemize}

\subsection{Các thủ tục chính}
Chức năng của chương trình được xây dựng qua một số thủ tục chính, mỗi thủ tục đảm nhận một nhiệm vụ cụ thể trong trò chơi:

\begin{itemize}
    \item \textbf{\texttt{INIT}}: Khởi tạo bàn cờ 15x15 bằng cách thiết lập tất cả các vị trí với ký hiệu '.' (trống). Gán 1 cho \texttt{player} để xác định người chơi đầu tiên. Gán 0 cho biến \texttt{move\_count} để theo dõi số nước đi đã thực hiện.
    \item \textbf{\texttt{PRINT\_BOARD}}: Hiển thị trạng thái hiện tại của bàn cờ lên màn hình cùng với các nhãn hàng và cột.
    \item \textbf{\texttt{GET\_MOVE}}: Yêu cầu người chơi nhập nước đi, đọc đầu vào, và kiểm tra tính hợp lệ thông qua \texttt{parse\_input}.
    \item \textbf{\texttt{parse\_input}}: Phân tích chuỗi đầu vào để trích xuất tọa độ, đồng thời kiểm tra định dạng, phạm vi hợp lệ và tính khả dụng của vị trí trên bàn cờ.
    \item \textbf{\texttt{UPDATE\_BOARD}}: Cập nhật bàn cờ bằng cách ghi ký hiệu của người chơi ('X' hoặc 'O') vào vị trí đã chọn.
    \item \textbf{\texttt{check\_win}}: Kiểm tra xem nước đi gần nhất có tạo thành chuỗi năm ký hiệu liên tiếp theo hàng, cột hoặc đường chéo hay không.
    \item \textbf{\texttt{check\_tie}}: Xác định xem trò chơi có kết thúc hòa khi bàn cờ đã đầy mà không có chiến thắng.
    \item \textbf{\texttt{SWITCH\_PLAYER\_TURN}}: Chuyển lượt của người chơi giữa Người chơi 1 và Người chơi 2.
    \item \textbf{\texttt{win\_process, tie\_process}}: Ghi lại trạng thái cuối cùng của bàn cờ và kết quả trò chơi vào file "result.txt".
\end{itemize}

Các thủ tục này được gọi trong các trạng thái của FSM như sau:
\begin{itemize}
    \item \textbf{Initialization}: Sử dụng \texttt{INIT} để thiết lập bàn cờ.
    \item \textbf{Player Turn}: Gọi \texttt{PRINT\_BOARD}, \texttt{GET\_MOVE}, \texttt{UPDATE\_BOARD}, \texttt{check\_win} và \texttt{check\_tie}.
    \item \textbf{Game Over (Win)}: Gọi \texttt{PRINT\_BOARD} và \texttt{win\_process} để hiển thị kết quả.
    \item \textbf{Game Over (Tie)}: Tương tự, gọi \texttt{PRINT\_BOARD} và \texttt{tie\_process}.
\end{itemize}
Sau khi kết thúc trò chơi, người dùng có thể chọn chơi lại hoặc thoát chương trình.